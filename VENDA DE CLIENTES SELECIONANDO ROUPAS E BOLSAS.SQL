CREATE TABLE FL_TRANS_ATÉ_MAR10_B AS SELECT 
TIPODOCUMENTOPAX, NUMERODOCUMENTOPAX, 
MAX(EMAIL) AS EMAIL, 
COUNT(DISTINCT(NUMEROCHECKOUT||SEQUENCIALOPERACAOCHECKOUT||NUMERONOTAVENDA)) AS TRANS,
SUM(NVL(PRECOUNITARIOVENDA,0)* NVL(QUANTIDADEVENDIDA,0)) AS VENDAS,
FROM 
(SELECT 
a.SIGLAAEROPORTO,
a.CODIGOLOJA,
a.TIPOLOJA,
case
when (b.codigogrupo||b.codigosubgrupo||b.codigotipo) in
('065320','065328','065355','066415','095320','060515','066903','066105',
'066404','067306','065541','065304','065504','065505','066902','065522',
'066104','065335','065337','066406','065339','065340','065549','065556',
'066121','067301','066419','066420','095335','095501','095504','095505',
'096105','096912','097306','096419','090608','090511','090521','090917',
'090816','065360','065412','065413','066418','060111','060510','060204',
'060205','090204','091106','091003','091203','091410','091513','092004',
'091310','060212','065517','065302','065543','066112','065550','095342',
'095543','097317','096112','096907','097307','090509','096427','090519',
'090620','090914','061343','061344','090817','031102','065537','066907',
'033806','065342','066114','065349','067317','060513','096408','061307',
'061347','061363','090714','065518','065315','066116','065354','066412',
'095315','095518','097314','096116','096412','096913','090504','090605',
'090909','061303','061310','066803','090818','065306','065525','065538',
'065325','066103','095306','095325','095525','095538','096103','097312',
'096125','096401','096902','097322','096917','096424','090505','090611',
'090513','090617','090305','090801','090913','090813','090919','065515',
'065313','065312','065501','065327','095312','096423','097308','090303',
'090802','090903','090624','065502','066405','065341','066127','067307',
'095341','095502','097319','096406','096909','096127','090613','090516',
'090910','090815','060113','061313','061314','090106','080533','065319',
'066102','066401','066801','066203','090410','060502','060503','060504',
'066428','090415','091802','090702','090703','090704','090705','090706',
'090708','090710','090711','090712','090713','060512','090709','060102',
'060103','060508','060509','060112','066924','090102','095814','090401',
'095822','090403','061201','090105','090701','091701','091801','091902',
'065516','065311','065506','065329','065331','065527','067305','066403',
'065540','065519','065303','065347','065555','065356','066119','066413',
'066120','095356','095303','095329','095516','095527','097318','096108',
'096119','096120','096403','096413','096903','096905','096908','096910',
'096914','097302','097305','097309','097311','090402','096418','095503',
'060514','090502','090601','090604','090609','090507','090508','090510',
'090612','090615','090306','090806','090906','090908','090912','090812',
'061311','090520','061341','061360','091905','090311','066802',
'090107') then 1 end as roupas,
case
when (b.codigogrupo||b.codigosubgrupo||b.codigotipo) in 
('080531','066003','065803','065801','052106','071935',
'068301','065834','065835','095803','095815','065838',
'061318','091101','091301','091502','061112','091309')
then 1 end as Bolsas,
to_char(a.DATAOPERACAOCHECKOUT, 'YYYY-MM') AS ANO_MES,
a.NUMEROCHECKOUT, a.TIPODOCUMENTOPAX, a.NUMERODOCUMENTOPAX,
a.SEQUENCIALOPERACAOCHECKOUT, a.NUMEROVOOPAX, a.dataoperacaocheckout,
a.NUMERONOTAVENDA, a.CODIGOBRASIF, a.PRECOUNITARIOVENDA, 
a.QUANTIDADEVENDIDA, C.ORIGEM, C.CIA_AEREA, D.EMAIL,
b.CODIGOGRUPO, b.CODIGOSUBGRUPO, b.CODIGOCATEGORIADUFRY,
b.DESCRICAOITEM,  b.IDENTIFICACAOMARCA
from itvet001 a, itemt027 b, FL_CLI_ATÉ_MAR10_A D
where  a.dataoperacaocheckout between to_date('01/01/2008', 'dd/mm/yyyy') and to_date('14/03/2010', 'dd/mm/yyyy')
and a.codigonegocio = '200'
and d.TIPO_DOC = a.tipodocumentopax
and d.NUM_DOC = a.numerodocumentopax
and (b.codigobrasif(+)=a.codigobrasif and a.codigonegocio = b.codigonegocio(+))
and nvl(a.indicadorestorno, 'N')='N')
group by TIPODOCUMENTOPAX, NUMERODOCUMENTOPAX
