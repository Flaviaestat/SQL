/*DF*/
SELECT ANO_MES, TIPOLOJA, CODIGOLOJA2, SIGLAAEROPORTO, NUMEROPARCELASCARTAO2, CARTAO,
FAIXA_INICIO, 
FAIXA_FIM,
SUM(VENDA_LÍQUIDA)VENDA_LÍQUIDA, 
COUNT(DISTINCT(NUMEROCHECKOUT||SEQUENCIALOPERACAOCHECKOUT))TRANS
FROM /*COMEÇA QUERY INTERNA*/(
SELECT  TIPOLOJA, 
NVL(VALORPAGAMENTOUS$, 0) - NVL(VALORTROCOMOEDABASE, 0) AS VENDA_LÍQUIDA, 
CASE
WHEN CODIGOLOJA='03' THEN '51'
ELSE CODIGOLOJA
END AS CODIGOLOJA2,
SIGLAAEROPORTO,
CASE 
WHEN CODIGOPAISPAX='1' THEN 'BRAS' ELSE 'ESTRANG' 
END AS NACIONALIDADE,
CASE 
WHEN ((codigomoeda = '1') OR (CODIGOMOEDACARTAO = '1'))  then '1-DOLAR'
WHEN ((codigomoeda = '13') OR (CODIGOMOEDACARTAO = '13')) THEN '2-REAL'
WHEN codigomoeda NOT IN ('13','1') then '0-OUTROS' WHEN codigomoedaCARTAO NOT IN ('13','1') then '0-OUTROS'
END AS MOEDA,
CASE WHEN codigomoeda IS NULL AND CODIGOADMINISTRADORACARTAO IN ('15','18','17','16','19','20','21') then 'CREDITO'
WHEN codigomoeda IS NULL AND CODIGOADMINISTRADORACARTAO IN ('33','32','31','30','29','28','25','26','27') then 'DEBITO'
WHEN codigomoeda IS NULL AND CODIGOADMINISTRADORACARTAO IS NULL then 'SI' 
END AS CARTAO,
CASE WHEN (NUMEROCARTAOCREDITO IS NULL AND CODIGOMOEDA IS NOT NULL) THEN 0 
WHEN (NUMEROCARTAOCREDITO IS NOT NULL AND TIPOPARCELAMENTOCARTAO='AV') THEN 1 
WHEN (NUMEROCARTAOCREDITO IS NOT NULL AND (TIPOPARCELAMENTOCARTAO IN ('PSJ','PCJ'))) THEN NUMEROPARCELASCARTAO
WHEN (NUMEROCARTAOCREDITO IS NOT NULL AND TIPOPARCELAMENTOCARTAO IS NULL) THEN 100 
END AS NUMEROPARCELASCARTAO2,
TIPOPARCELAMENTOCARTAO,
NUMEROCHECKOUT,SEQUENCIALOPERACAOCHECKOUT, 
/*OUTRA QUERY INTERNA TRAZENDO FAIXA INICIO EM VENDA BRUTA*/
(SELECT case when mod(b.valornotavendabruto, 100)>50 then (b.valornotavendabruto- mod(b.valornotavendabruto, 100))+50
else (b.valornotavendabruto- mod(b.valornotavendabruto, 100))
end as faixa_inicio FROM VNDAT004 B WHERE A.NUMEROCHECKOUT = B.NUMEROCHECKOUT 
AND A.SEQUENCIALOPERACAOCHECKOUT = B.SEQUENCIALOPERACAOCHECKOUT) AS FAIXA_INICIO,/*FECHOU*/
/*OUTRA QUERY INTERNA TRAZENDO FAIXA FIM EM VENDA BRUTA*/
(SELECT case when mod(b.valornotavendabruto, 100)>50 then (b.valornotavendabruto- mod(b.valornotavendabruto, 100))+100
else (b.valornotavendabruto- mod(b.valornotavendabruto, 100))+50
end as faixa_fim FROM VNDAT004 B WHERE A.NUMEROCHECKOUT = B.NUMEROCHECKOUT 
AND A.SEQUENCIALOPERACAOCHECKOUT = B.SEQUENCIALOPERACAOCHECKOUT) AS FAIXA_FIM,/*FECHOU*/
TO_CHAR(DATAOPERACAOCHECKOUT, 'YYYY-MM') AS ANO_MES
FROM PGTOT001 a WHERE NVL(indicadorestorno,'N')  = 'N'
AND codigonegocio = '200' AND DATAOPERACAOCHECKOUT between '01-JAN-2009' and '31-JAN-2010') 
/*TERMINA QUERY INTERNA*/
GROUP BY ANO_MES, TIPOLOJA, CODIGOLOJA2, SIGLAAEROPORTO, NUMEROPARCELASCARTAO2, CARTAO, FAIXA_INICIO, FAIXA_FIM

