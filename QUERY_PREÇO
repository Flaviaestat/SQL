CREATE TABLE FL_BASEMODELAGEM_FAIXA AS select ANO_MES, FAIXA, 
SUM(NVL(precounitariovenda,0)* NVL(quantidadevendida,0)) as vendas,
COUNT(DISTINCT(NUMEROCHECKOUT||SEQUENCIALOPERACAOCHECKOUT||NUMERONOTAVENDA)) AS TRANS,
SUM(NVL(quantidadevendida,0)) AS qtd
from 
(SELECT 
a.SIGLAAEROPORTO,
CASE
WHEN a.PRECOUNITARIOVENDA<=10 THEN 'FAIXA1'
WHEN a.PRECOUNITARIOVENDA>10 AND a.PRECOUNITARIOVENDA<=30 THEN 'FAIXA2'
WHEN a.PRECOUNITARIOVENDA>30 AND a.PRECOUNITARIOVENDA<=50 THEN 'FAIXA3'
WHEN a.PRECOUNITARIOVENDA>50 AND a.PRECOUNITARIOVENDA<=70 THEN 'FAIXA4'
WHEN a.PRECOUNITARIOVENDA>70 AND a.PRECOUNITARIOVENDA<=90 THEN 'FAIXA5'
WHEN a.PRECOUNITARIOVENDA>90 AND a.PRECOUNITARIOVENDA<=150 THEN 'FAIXA6'
WHEN a.PRECOUNITARIOVENDA>150 THEN 'FAIXA7'
END AS FAIXA,
a.CODIGOLOJA,
a.TIPOLOJA,
a.DATAOPERACAOCHECKOUT, 
to_char(a.DATAOPERACAOCHECKOUT, 'YYYY-MM') AS ANO_MES,
a.INDICADORESTORNO, 
a.NUMEROCHECKOUT, 
a.SEQUENCIALOPERACAOCHECKOUT,
a.NUMERONOTAVENDA,
a.CODIGOBRASIF,
a.PRECOUNITARIOVENDA, a.QUANTIDADEVENDIDA, 
b.CODIGOGRUPO, b.CODIGOSUBGRUPO, b.CODIGOCATEGORIADUFRY,
b.DESCRICAOITEM,  b.IDENTIFICACAOMARCA
from itvet001 a, itemt027 b
where  a.dataoperacaocheckout between '01-JAN-2003' and '31-MAY-2009'
and a.codigonegocio = '200' and b.codigocategoriadufry = '40' and A.tipoloja in('E','D')
and (b.codigobrasif(+)=a.codigobrasif and a.codigonegocio = b.codigonegocio(+))
and nvl(a.indicadorestorno, 'N')='N')
group by ANO_MES, FAIXA

DROP TABLE FL_BASEMODELAGEM_FAIXA

SELECT * FROM FL_BASEMODELAGEM_FAIXA
